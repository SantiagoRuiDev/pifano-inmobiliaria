<?php
    // --- 0. CONFIGURACIÓN REGIONAL ---
    date_default_timezone_set('America/Argentina/Buenos_Aires');

    // --- 1. LÓGICA DE IMAGEN (SOLUCIÓN BASE64) ---
    $base_path = dirname(__DIR__, 2); 
    $logo_path = $base_path . '/public/images/pifanoloazul-removebg-preview.png';
    
    $logo_src = "";
    if (file_exists($logo_path)) {
        $type = pathinfo($logo_path, PATHINFO_EXTENSION);
        $data = file_get_contents($logo_path);
        $logo_src = 'data:image/' . $type . ';base64,' . base64_encode($data);
    }

    // --- 2. FUNCIÓN NUMERO A LETRAS ---
    function numeroALetras($monto) {
        $monto = str_replace(',', '', $monto); 
        $monto = number_format($monto, 2, '.', ''); 
        $partes = explode('.', $monto);
        $entero = (int)$partes[0];

        $convertir = function($n) {
            $unidades = ['', 'UN', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE', 'DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECISEIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE', 'VEINTE', 'VEINTIUN', 'VEINTIDOS', 'VEINTITRES', 'VEINTICUATRO', 'VEINTICINCO', 'VEINTISEIS', 'VEINTISIETE', 'VEINTIOCHO', 'VEINTINUEVE'];
            $decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
            $centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];
            if ($n == 0) return '';
            if ($n < 30) return $unidades[$n];
            if ($n < 100) { $d = floor($n / 10); $u = $n % 10; return $decenas[$d] . ($u > 0 ? ' Y ' . $unidades[$u] : ''); }
            if ($n < 1000) { $c = floor($n / 100); $r = $n % 100; if ($n == 100) return 'CIEN'; return $centenas[$c] . ($r > 0 ? ' ' . $this($r) : ''); }
            return '';
        };
        
        $texto = '';
        if ($entero == 0) $texto = 'CERO';
        else {
            $millones = floor($entero / 1000000);
            $miles = floor(($entero % 1000000) / 1000);
            $cientos = $entero % 1000;
            if ($millones > 0) { if ($millones == 1) $texto .= 'UN MILLON '; else $texto .= convertirGrupo($millones) . ' MILLONES '; }
            if ($miles > 0) { if ($miles == 1) $texto .= 'MIL '; else $texto .= convertirGrupo($miles) . ' MIL '; }
            if ($cientos > 0) { $texto .= convertirGrupo($cientos); }
        }
        return trim($texto);
    }

    function convertirGrupo($n) {
        $unidades = ['', 'UN', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE', 'DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECISEIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE', 'VEINTE', 'VEINTIUN', 'VEINTIDOS', 'VEINTITRES', 'VEINTICUATRO', 'VEINTICINCO', 'VEINTISEIS', 'VEINTISIETE', 'VEINTIOCHO', 'VEINTINUEVE'];
        $decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
        $centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];
        $salida = '';
        if ($n == 100) return 'CIEN';
        if ($n >= 100) { $c = floor($n / 100); $salida .= $centenas[$c] . ' '; $n %= 100; }
        if ($n >= 30) { $d = floor($n / 10); $salida .= $decenas[$d]; $n %= 10; if ($n > 0) $salida .= ' Y '; }
        if ($n > 0) { $salida .= $unidades[$n]; }
        return trim($salida);
    }

    // --- 3. OBTENCIÓN DE DATOS ---
    if (!isset($rentData) || !$rentData) { echo "<h1>Error: Datos no encontrados.</h1>"; return; }
    
    // Configuración de Meses
    $meses_es = [1 => 'ENERO', 2 => 'FEBRERO', 3 => 'MARZO', 4 => 'ABRIL', 5 => 'MAYO', 6 => 'JUNIO', 7 => 'JULIO', 8 => 'AGOSTO', 9 => 'SEPTIEMBRE', 10 => 'OCTUBRE', 11 => 'NOVIEMBRE', 12 => 'DICIEMBRE'];

    // --- FECHA DE EMISIÓN (HOY) ---
    // Usamos la fecha actual del sistema para el encabezado
    $fecha_emision = new DateTime(); // Toma "ahora"
    $diaActual = $fecha_emision->format('d');
    $mesActualStr = $meses_es[(int)$fecha_emision->format('n')]; 
    $anioActual = $fecha_emision->format('Y');

    // --- FECHA DEL PERÍODO (BASE DE DATOS) ---
    // Usamos la fecha guardada en la DB para saber qué mes se está cobrando
    $generation_date_str = $rentData->generation_date ?? date('Y-m-d');
    try {
        $fecha_periodo = new DateTime($generation_date_str);
        $mes_recibo = $meses_es[(int)$fecha_periodo->format('n')];
        $anio_recibo = $fecha_periodo->format('Y');
    } catch (Exception $e) {
        $mes_recibo = 'ERROR';
        $anio_recibo = '----';
    }

    $monto_alquiler = (float) ($rentData->amount ?? 0);
    $honorarium_percent = (float) ($rentData->honorarium ?? 0);
    $descuento_otros = (float) ($rentData->discount ?? 0);
    $honorarium_discount = $monto_alquiler * ($honorarium_percent / 100);
    $total_a_pagar = $monto_alquiler - $honorarium_discount - $descuento_otros;
    
    $monto_en_letras = numeroALetras($monto_alquiler);

    $tenant_full_name = htmlspecialchars($rentData->tenant_name ?? '') . ' ' . htmlspecialchars($rentData->tenant_lastname ?? '');
    $tenant_dni = htmlspecialchars($rentData->tenant_dni ?? '');
    $property_location = htmlspecialchars($rentData->property_address ?? '') . ', ' . htmlspecialchars($rentData->property_city ?? '');
    
    $labels = ['ORIGINAL', 'DUPLICADO', 'TRIPLICADO'];
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"> 
    <style>
        @page { margin: 8mm 10mm; }
        body { font-family: 'Helvetica', sans-serif; margin: 0; padding: 0; color: #053e4e; }

        .receipt-wrapper {
            height: 128mm; 
            width: 100%;
            position: relative;
            box-sizing: border-box;
            padding-top: 5px;
        }

        .receipt-box { 
            border: 3px solid #053e4e; 
            padding: 15px 20px; 
            height: 120mm; 
            position: relative;
        }

        /* HEADER */
        .header-table { width: 100%; margin-bottom: 10px; }
        .header-table td { vertical-align: top; }
        
        .logo-text { font-size: 18pt; font-weight: 900; margin: 0; color: #053e4e; letter-spacing: -0.5px; line-height: 1; }
        .logo-subtext { font-size: 8pt; color: #053e4e; margin: 0; text-transform: uppercase; line-height: 1.2; }
        .info-header { font-size: 8pt; color: #555; margin-top: 5px; line-height: 1.2; }

        .date-table { 
            width: 200px; 
            border-collapse: collapse; 
            margin-left: auto; 
            font-size: 9pt; 
            color: #053e4e;
            text-align: center;
        }
        .date-table th { border: 1px solid #053e4e; padding: 2px; font-weight: bold; }
        .date-table td { border: 1px solid #053e4e; padding: 3px; font-weight: bold; }
        
        .copy-label { font-size: 9pt; color: #999; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; text-align: right; }
        .receipt-number { font-size: 14pt; font-weight: 900; color: #053e4e; margin-bottom: 2px; text-align: right; }
        .cuit-info { font-size: 8pt; text-align: right; margin-top: 5px; color: #555; }

        .separator-line { border-bottom: 2px solid #053e4e; margin: 10px 0 15px 0; }

        /* CUERPO */
        .row-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
        .row-table td { font-size: 10pt; vertical-align: bottom; color: #000; }
        
        .label { white-space: nowrap; padding-right: 5px; font-weight: normal; }
        .fill { border-bottom: 1px dashed #000; font-weight: bold; padding-left: 5px; width: 100%; }
        .fill-fixed { border-bottom: 1px dashed #000; font-weight: bold; padding-left: 5px; text-align: center; }

        .amount-words { font-size: 8pt; font-weight: normal; margin-left: 10px; text-transform: uppercase; }

        /* DETALLE */
        .detail-title { font-weight: 900; font-size: 10pt; color: #053e4e; border-bottom: 2px solid #053e4e; margin: 10px 0 5px 0; text-transform: uppercase; }
        
        /* FOOTER */
        .footer-table { width: 100%; margin-top: 20px; }
        .footer-table td { vertical-align: bottom; }
        
        .payment-method { font-weight: 900; font-size: 10pt; color: #000; margin-bottom: 5px; }
        .signature-line { border-top: 1px solid #000; width: 200px; text-align: center; font-size: 8pt; margin-top: 40px; }
        
        .total-box { border: 3px solid #053e4e; padding: 5px 10px; text-align: right; font-size: 14pt; font-weight: 900; color: #000; width: 220px; margin-left: auto; }

        .cut-line { border-bottom: 1px dashed #999; margin: 5mm 0; position: relative; }
        .cut-line::after { content: "✂"; position: absolute; right: 0; top: -10px; font-size: 14px; color: #999; }

    </style>
</head>
<body>

    <?php for ($i = 0; $i < 3; $i++): ?>

    <div class="receipt-wrapper">
        <div class="receipt-box">
            
            <table class="header-table">
                <tr>
                    <td style="width: 60%;">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 90px; vertical-align: top; padding-right: 10px;">
                                    <?php if($logo_src): ?>
                                        <img src="<?= $logo_src ?>" style="width: 80px; height: auto;" alt="Logo AP">
                                    <?php else: ?>
                                        <div style="font-size: 30pt; font-weight: bold; color: #053e4e;">AP</div>
                                    <?php endif; ?>
                                </td>
                                <td style="vertical-align: top; padding-top: 5px;">
                                    <div class="logo-text">AGUSTIN PIFANO</div>
                                    <div class="logo-subtext">MARTILLERO Y CORREDOR PÚBLICO</div>
                                    <div class="logo-subtext">MATRÍCULA 1840 TOMO VII FOLIO 131</div>
                                </td>
                            </tr>
                        </table>
                        
                        <div class="info-header">
                            Av. Roque Sáenz Peña 71° // Benito Juárez, Bs. As.<br>
                            2281-461194 // pifanoagustin19@gmail.com
                        </div>
                    </td>
                    
                    <td style="width: 40%;">
                        <div class="copy-label"><?= $labels[$i] ?></div>
                        <div class="receipt-number">RECIBO N°....</div>
                        
                        <table class="date-table">
                            <tr><th width="25%">DÍA</th><th width="50%">MES</th><th width="25%">AÑO</th></tr>
                            <tr><td><?= $diaActual ?></td><td><?= $mesActualStr ?></td><td><?= $anioActual ?></td></tr>
                        </table>
                        
                        <div class="cuit-info">
                            C.U.I.T. / Ing. Brutos: 20-62779909-4<br>
                            Inicio de act: 01/11/2022
                        </div>
                    </td>
                </tr>
            </table>

            <div class="separator-line"></div>

            <table class="row-table">
                <tr>
                    <td class="label">Recibí de los Sr/es.</td>
                    <td class="fill" style="width: 55%; font-weight: 900;"><?= $tenant_full_name ?></td>
                    <td class="label" style="padding-left: 10px;">, D.N.I.</td>
                    <td class="fill-fixed" style="width: 25%; font-weight: 900;"><?= $tenant_dni ?></td>
                </tr>
            </table>

            <table class="row-table">
                <tr>
                    <td class="label">la cantidad de pesos</td>
                    <td class="fill">
                        <span style="font-weight: 900;"><?= number_format($monto_alquiler, 2, ',', '.') ?></span>
                        <span class="amount-words">(<?= $monto_en_letras ?>)</span>
                    </td>
                    <td class="label" style="padding-left: 5px;">$</td>
                </tr>
            </table>

            <table class="row-table">
                <tr>
                    <td class="label">en concepto de pago de alquiler, por el/la</td>
                    <td class="fill-fixed" style="width: 30%; font-weight: 900;">PROPIEDAD</td>
                    <td class="label" style="padding-left: 10px;">ubicado/a en</td>
                    <td class="fill"></td>
                </tr>
            </table>
            
            <table class="row-table">
                <tr>
                    <td class="fill" style="width: 60%; font-weight: 900;"><?= $property_location ?></td>
                    <td class="label" style="padding-left: 10px;">, MES/PERÍODO</td>
                    <td class="fill-fixed" style="width: 25%; font-weight: 900;"><?= $mes_recibo . '/' . $anio_recibo ?></td>
                </tr>
            </table>

            <div class="detail-title">DETALLE:</div>
            
            <div style="min-height: 20px;">
                <?php if($honorarium_discount > 0): ?>
                    <div style="font-size: 9pt;">Desc. Honorarios: - $ <?= number_format($honorarium_discount, 2, ',', '.') ?></div>
                <?php endif; ?>
                <?php if($descuento_otros > 0): ?>
                    <div style="font-size: 9pt;">Otros Descuentos: - $ <?= number_format($descuento_otros, 2, ',', '.') ?></div>
                <?php endif; ?>
            </div>

            <div style="border-bottom: 1px solid #053e4e; margin-bottom: 15px;"></div>

            <table class="footer-table">
                <tr>
                    <td style="width: 50%;">
                        <div class="payment-method">MÉTODO DE PAGO: <?= htmlspecialchars($rentData->payment_method ?? 'efectivo') ?></div>
                        <div style="border-bottom: 1px dashed #000; width: 100%; margin-bottom: 30px;"></div>
                        <div class="signature-line">FIRMA LOCATARIO</div>
                    </td>
                    <td style="width: 50%; text-align: right;">
                        <div class="total-box">
                            TOTAL: $ <?= number_format($total_a_pagar, 2, ',', '.') ?>
                        </div>
                    </td>
                </tr>
            </table>

        </div>
    </div>

    <?php 
    if ($i == 0) { echo '<div class="cut-line"></div>'; } 
    elseif ($i == 1) { echo '<div style="page-break-after: always;"></div>'; }
    ?>

    <?php endfor; ?>

</body>
</html>