<?php
    // --- 1. FUNCIÓN DE CONVERSIÓN (Limpia y robusta) ---
    function convertirGrupo($n) {
        $unidades = ['', 'UN', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE', 'DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECISEIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE', 'VEINTE', 'VEINTIUN', 'VEINTIDOS', 'VEINTITRES', 'VEINTICUATRO', 'VEINTICINCO', 'VEINTISEIS', 'VEINTISIETE', 'VEINTIOCHO', 'VEINTINUEVE'];
        $decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
        $centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];

        $salida = '';

        if ($n == 100) return 'CIEN';
        
        if ($n >= 100) {
            $c = floor($n / 100);
            $salida .= $centenas[$c] . ' ';
            $n %= 100;
        }

        if ($n >= 30) {
            $d = floor($n / 10);
            $salida .= $decenas[$d];
            $n %= 10;
            if ($n > 0) $salida .= ' Y ';
        } else if ($n > 0) {
            $salida .= $unidades[$n];
        }

        return trim($salida);
    }

    function numeroALetras($monto) {
        // Aseguramos que sea un número limpio
        $monto = (float)str_replace(',', '', $monto); 
        $entero = floor($monto);
        
        if ($entero == 0) return 'CERO';
        if ($entero > 999999999) return 'ALTO VALOR';

        $millones = floor($entero / 1000000);
        $miles = floor(($entero % 1000000) / 1000);
        $cientos = $entero % 1000;

        $texto = '';

        if ($millones > 0) {
            if ($millones == 1) $texto .= 'UN MILLON ';
            else $texto .= convertirGrupo($millones) . ' MILLONES ';
        }

        if ($miles > 0) {
            if ($miles == 1) $texto .= 'MIL ';
            else $texto .= convertirGrupo($miles) . ' MIL ';
        }

        if ($cientos > 0) {
            $texto .= convertirGrupo($cientos);
        }

        return trim($texto);
    }

    // --- 2. OBTENCIÓN DE DATOS ---
    if (!isset($rentData) || !$rentData) { echo "<h1>Error: Datos no encontrados.</h1>"; return; }
    
    // Fechas
    $generation_date_str = $rentData->generation_date ?? date('Y-m-d');
    setlocale(LC_TIME, 'es_ES.utf8', 'es_ES', 'es');
    $meses_es = [1 => 'ENERO', 2 => 'FEBRERO', 3 => 'MARZO', 4 => 'ABRIL', 5 => 'MAYO', 6 => 'JUNIO', 7 => 'JULIO', 8 => 'AGOSTO', 9 => 'SEPTIEMBRE', 10 => 'OCTUBRE', 11 => 'NOVIEMBRE', 12 => 'DICIEMBRE'];
    
    try {
        $date_obj = new DateTime($generation_date_str);
        $diaActual = $date_obj->format('d');
        $mesActualStr = $meses_es[(int)$date_obj->format('n')]; 
        $anioActual = $date_obj->format('Y');
        
        $mes_recibo = $mesActualStr;
        $anio_recibo = $anioActual;
    } catch (Exception $e) {
        $diaActual = '--'; $mesActualStr = 'Error'; $anioActual = '----';
    }

    // Montos
    $monto_alquiler = (float) ($rentData->amount ?? 0);
    $honorarium_percent = (float) ($rentData->honorarium ?? 0);
    $descuento_otros = (float) ($rentData->discount ?? 0);
    $honorarium_discount = $monto_alquiler * ($honorarium_percent / 100);
    $total_a_pagar = $monto_alquiler - $honorarium_discount - $descuento_otros;
    
    // **AQUÍ SE GENERA EL TEXTO DINÁMICO**
    $monto_en_letras = numeroALetras($monto_alquiler);

    // Textos
    $tenant_full_name = htmlspecialchars($rentData->tenant_name ?? '') . ' ' . htmlspecialchars($rentData->tenant_lastname ?? '');
    $tenant_dni = htmlspecialchars($rentData->tenant_dni ?? '');
    $property_location = htmlspecialchars($rentData->property_address ?? '') . ', ' . htmlspecialchars($rentData->property_city ?? '');
    
    $labels = ['ORIGINAL', 'DUPLICADO', 'TRIPLICADO'];
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"> 
    <style>
        /* Márgenes ajustados para A4 (2 recibos página 1, 1 en página 2) */
        @page { margin: 8mm 10mm; }
        body { font-family: 'Helvetica', sans-serif; margin: 0; padding: 0; color: #053e4e; }

        .receipt-wrapper {
            height: 128mm; /* Altura ajustada */
            width: 100%;
            position: relative;
            box-sizing: border-box;
            padding-top: 5px;
        }

        .receipt-box { 
            border: 3px solid #053e4e; 
            padding: 15px 20px; 
            height: 120mm; 
            position: relative;
        }

        /* HEADER */
        .header-table { width: 100%; margin-bottom: 10px; }
        .header-table td { vertical-align: top; }
        
        .logo-ap { font-size: 32pt; font-weight: 900; margin: 0; line-height: 0.8; color: #053e4e; }
        .logo-text { font-size: 18pt; font-weight: 900; margin: 5px 0 0 0; color: #053e4e; letter-spacing: -0.5px; }
        .logo-subtext { font-size: 8pt; color: #053e4e; margin: 0; text-transform: uppercase; }
        .info-header { font-size: 8pt; color: #555; margin-top: 5px; line-height: 1.2; }

        .date-table { 
            width: 200px; 
            border-collapse: collapse; 
            margin-left: auto; 
            font-size: 9pt; 
            color: #053e4e;
            text-align: center;
        }
        .date-table th { border: 1px solid #053e4e; padding: 2px; font-weight: bold; }
        .date-table td { border: 1px solid #053e4e; padding: 3px; font-weight: bold; }
        
        .copy-label { font-size: 9pt; color: #999; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; text-align: right; }
        .receipt-number { font-size: 14pt; font-weight: 900; color: #053e4e; margin-bottom: 2px; text-align: right; }
        .cuit-info { font-size: 8pt; text-align: right; margin-top: 5px; color: #555; }

        .separator-line { border-bottom: 2px solid #053e4e; margin: 10px 0 15px 0; }

        /* CUERPO */
        .row-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
        .row-table td { font-size: 10pt; vertical-align: bottom; color: #000; }
        
        .label { white-space: nowrap; padding-right: 5px; font-weight: normal; }
        .fill { 
            border-bottom: 1px dashed #000; 
            font-weight: 900; /* Texto en negrita */
            padding-left: 5px; 
            width: 100%; 
        }
        .fill-fixed {
            border-bottom: 1px dashed #000; 
            font-weight: 900; 
            padding-left: 5px; 
            text-align: center;
        }

        .amount-words { font-size: 8pt; font-weight: normal; margin-left: 10px; text-transform: uppercase; }

        /* DETALLE */
        .detail-title { 
            font-weight: 900; font-size: 10pt; color: #053e4e; 
            border-bottom: 2px solid #053e4e; 
            margin: 10px 0 5px 0; 
            text-transform: uppercase; 
        }
        
        /* FOOTER */
        .footer-table { width: 100%; margin-top: 20px; }
        .footer-table td { vertical-align: bottom; }
        
        .payment-method { font-weight: 900; font-size: 10pt; color: #000; margin-bottom: 5px; }
        .signature-line { border-top: 1px solid #000; width: 200px; text-align: center; font-size: 8pt; margin-top: 40px; }
        
        .total-box {
            border: 3px solid #053e4e;
            padding: 5px 10px;
            text-align: right;
            font-size: 14pt;
            font-weight: 900;
            color: #000;
            width: 220px;
            margin-left: auto;
        }

        .cut-line { border-bottom: 1px dashed #999; margin: 5mm 0; position: relative; }
        .cut-line::after { content: "✂"; position: absolute; right: 0; top: -10px; font-size: 14px; color: #999; }

    </style>
</head>
<body>

    <?php for ($i = 0; $i < 3; $i++): ?>

    <div class="receipt-wrapper">
        <div class="receipt-box">
            
            <table class="header-table">
                <tr>
                    <td style="width: 60%;">
                        <div class="logo-ap">AP</div>
                        <div class="logo-text">AGUSTIN PIFANO</div>
                        <div class="logo-subtext">MARTILLERO Y CORREDOR PÚBLICO</div>
                        <div class="logo-subtext">MATRÍCULA 1840 TOMO VII FOLIO 131</div>
                        <div class="info-header">
                            Av. Roque Sáenz Peña 71° // Benito Juárez, Bs. As.<br>
                            2281-461194 // pifanoagustin19@gmail.com
                        </div>
                    </td>
                    <td style="width: 40%;">
                        <div class="copy-label"><?= $labels[$i] ?></div>
                        <div class="receipt-number">RECIBO N°....</div>
                        
                        <table class="date-table">
                            <tr>
                                <th width="25%">DÍA</th>
                                <th width="50%">MES</th>
                                <th width="25%">AÑO</th>
                            </tr>
                            <tr>
                                <td><?= $diaActual ?></td>
                                <td><?= $mesActualStr ?></td>
                                <td><?= $anioActual ?></td>
                            </tr>
                        </table>
                        
                        <div class="cuit-info">
                            C.U.I.T. / Ing. Brutos: 20-62779909-4<br>
                            Inicio de act: 01/11/2022
                        </div>
                    </td>
                </tr>
            </table>

            <div class="separator-line"></div>

            <table class="row-table">
                <tr>
                    <td class="label">Recibí de los Sr/es.</td>
                    <td class="fill" style="width: 55%;"><?= $tenant_full_name ?></td>
                    <td class="label" style="padding-left: 10px;">, D.N.I.</td>
                    <td class="fill-fixed" style="width: 25%;"><?= $tenant_dni ?></td>
                </tr>
            </table>

            <table class="row-table">
                <tr>
                    <td class="label">la cantidad de pesos</td>
                    <td class="fill">
                        <?= number_format($monto_alquiler, 2, ',', '.') ?>
                        <span class="amount-words">(<?= $monto_en_letras ?>)</span>
                    </td>
                    <td class="label" style="padding-left: 5px;">$</td>
                </tr>
            </table>

            <table class="row-table">
                <tr>
                    <td class="label">en concepto de pago de alquiler, por el/la</td>
                    <td class="fill-fixed" style="width: 30%;">PROPIEDAD</td>
                    <td class="label" style="padding-left: 10px;">ubicado/a en</td>
                    <td class="fill"></td>
                </tr>
            </table>
            
            <table class="row-table">
                <tr>
                    <td class="fill" style="width: 60%;"><?= $property_location ?></td>
                    <td class="label" style="padding-left: 10px;">, MES/PERÍODO</td>
                    <td class="fill-fixed" style="width: 25%;"><?= $mes_recibo . '/' . $anio_recibo ?></td>
                </tr>
            </table>

            <div class="detail-title">DETALLE:</div>
            
            <div style="min-height: 20px;">
                <?php if($honorarium_discount > 0): ?>
                    <div style="font-size: 9pt;">Desc. Honorarios: - $ <?= number_format($honorarium_discount, 2, ',', '.') ?></div>
                <?php endif; ?>
                <?php if($descuento_otros > 0): ?>
                    <div style="font-size: 9pt;">Otros Descuentos: - $ <?= number_format($descuento_otros, 2, ',', '.') ?></div>
                <?php endif; ?>
            </div>

            <div style="border-bottom: 1px solid #053e4e; margin-bottom: 15px;"></div>

            <table class="footer-table">
                <tr>
                    <td style="width: 50%;">
                        <div class="payment-method">MÉTODO DE PAGO: <?= htmlspecialchars($rentData->payment_method ?? 'efectivo') ?></div>
                        <div style="border-bottom: 1px dashed #000; width: 100%; margin-bottom: 30px;"></div>
                        <div class="signature-line">FIRMA LOCATARIO</div>
                    </td>
                    <td style="width: 50%; text-align: right;">
                        <div class="total-box">
                            TOTAL: $ <?= number_format($total_a_pagar, 2, ',', '.') ?>
                        </div>
                    </td>
                </tr>
            </table>

        </div>
    </div>

    <?php 
    if ($i == 0) { echo '<div class="cut-line"></div>'; } 
    elseif ($i == 1) { echo '<div style="page-break-after: always;"></div>'; }
    ?>

    <?php endfor; ?>

</body>
</html>